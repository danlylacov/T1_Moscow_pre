{% set dockerfile_paths = ctx.dockerfile_paths or (ctx.dockerfile_path and [ctx.dockerfile_path] or []) %}
{% set is_single_dockerfile = dockerfile_paths|length == 1 %}
{% set single_dockerfile_in_root = is_single_dockerfile and (dockerfile_paths[0] == "Dockerfile" or "/" not in dockerfile_paths[0]) %}
{% if dockerfile_paths|length > 0 and not single_dockerfile_in_root %}
{# Несколько Dockerfile или один не в корне - билдим все #}
docker_build:
  stage: docker_build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  script:
{% for dockerfile_path in dockerfile_paths %}
{% set dockerfile_dir = dockerfile_path.rsplit('/', 1)[0] if '/' in dockerfile_path else '.' %}
{% set service_name_raw = dockerfile_dir.split('/')[-1] if dockerfile_dir != '.' else 'main' %}
{% set service_name = service_name_raw | lower %}
{% set service_name_safe = service_name_raw | lower | replace('-', '_') | replace('/', '_') %}
{% set image_name = (ctx.project_name | default("myapp")) | lower %}
{% set image_tag = ctx.tag | default("$CI_COMMIT_SHORT_SHA") %}
{% set registry = ctx.registry | default("$CI_REGISTRY") %}
{% if registry == "$CI_REGISTRY" or registry == "$CI_REGISTRY_IMAGE" %}
{% set full_image_name = "$CI_REGISTRY_IMAGE-" + service_name %}
{% else %}
{% set full_image_name = registry + "/" + image_name + "-" + service_name %}
{% endif %}
    - echo "Building {{ dockerfile_path }}..."
{% if registry == "$CI_REGISTRY" or registry == "$CI_REGISTRY_IMAGE" %}
    - docker build -f {{ dockerfile_path }} -t $CI_REGISTRY_IMAGE-{{ service_name }}:{{ image_tag }} {{ dockerfile_dir | default(".", true) }}
    - docker save -o image-{{ service_name_safe }}.tar $CI_REGISTRY_IMAGE-{{ service_name }}:{{ image_tag }} || true
{% else %}
    - docker build -f {{ dockerfile_path }} -t {{ full_image_name }}:{{ image_tag }} {{ dockerfile_dir | default(".", true) }}
    - docker save -o image-{{ service_name_safe }}.tar {{ full_image_name }}:{{ image_tag }} || true
{% endif %}
{% endfor %}
  artifacts:
    paths:
{% for dockerfile_path in dockerfile_paths %}
{% set dockerfile_dir = dockerfile_path.rsplit('/', 1)[0] if '/' in dockerfile_path else '.' %}
{% set service_name_raw = dockerfile_dir.split('/')[-1] if dockerfile_dir != '.' else 'main' %}
{% set service_name_safe = service_name_raw | lower | replace('-', '_') | replace('/', '_') %}
      - image-{{ service_name_safe }}.tar
{% endfor %}
{% else %}
{# Один Dockerfile в корне - используем стандартные переменные #}
docker_build:
  stage: docker_build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  script:
    - docker build -f {{ ctx.dockerfile_path | default("Dockerfile") }} -t $DOCKER_IMAGE:$DOCKER_TAG {{ ctx.docker_context | default(".", true) }}
    - docker save -o image.tar $DOCKER_IMAGE:$DOCKER_TAG || true
  artifacts:
    paths:
      - image.tar
{% endif %}
