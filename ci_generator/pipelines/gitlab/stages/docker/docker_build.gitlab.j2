{% set dockerfile_paths = ctx.dockerfile_paths or (ctx.dockerfile_path and [ctx.dockerfile_path] or []) %}
{% set is_single_dockerfile = dockerfile_paths|length == 1 %}
{% set single_dockerfile_in_root = is_single_dockerfile and (dockerfile_paths[0] == "Dockerfile" or "/" not in dockerfile_paths[0]) %}
{% if dockerfile_paths|length > 0 and not single_dockerfile_in_root %}
{# –ù–µ—Å–∫–æ–ª—å–∫–æ Dockerfile - –æ–¥–Ω–∞ –¥–∂–æ–±–∞ build_and_push –¥–ª—è –≤—Å–µ—Ö #}
build_and_push:
  stage: docker_build
  image: docker:24
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - docker info
    - echo "Checking GitLab CI variables..."
    - echo "Logging to GitLab Container Registry with CI_JOB_TOKEN..."
    - echo "$CI_JOB_TOKEN" | docker login -u "gitlab-ci-token" "$CI_REGISTRY" --password-stdin
  script:
    - echo "Building and pushing Docker images..."
{% for dockerfile_path in dockerfile_paths %}
{% set dockerfile_dir = dockerfile_path.rsplit('/', 1)[0] if '/' in dockerfile_path else '.' %}
{% set service_name_raw = dockerfile_dir.split('/')[-1] if dockerfile_dir != '.' else 'main' %}
{% set service_name = service_name_raw | lower %}
{% set service_name_display = service_name_raw | replace('-', ' ') | title %}
    
    # {{ service_name_display }}
    - echo "Building {{ service_name_display }}..."
    - docker build -f {{ dockerfile_path }} -t $CI_REGISTRY_IMAGE-{{ service_name }}:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-{{ service_name }}:latest {{ dockerfile_dir | default(".", true) }}
    - echo "Pushing {{ service_name_display }}..."
    - docker push $CI_REGISTRY_IMAGE-{{ service_name }}:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-{{ service_name }}:latest || echo "Failed to push latest tag"
    - echo "‚úÖ {{ service_name_display }} pushed successfully"
{% endfor %}
    
    - echo "üéâ All images built and pushed successfully!"
  after_script:
    - docker logout $CI_REGISTRY || true
{% else %}
{# –û–¥–∏–Ω Dockerfile –≤ –∫–æ—Ä–Ω–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ #}
docker_build:
  stage: docker_build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  script:
    - docker build -f {{ ctx.dockerfile_path | default("Dockerfile") }} -t $DOCKER_IMAGE:$DOCKER_TAG {{ ctx.docker_context | default(".", true) }}
    - docker save -o image.tar $DOCKER_IMAGE:$DOCKER_TAG || true
  artifacts:
    paths:
      - image.tar
{% endif %}
