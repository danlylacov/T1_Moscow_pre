{% set dockerfile_paths = ctx.dockerfile_paths or (ctx.dockerfile_path and [ctx.dockerfile_path] or []) %}
{% set is_single_dockerfile = dockerfile_paths|length == 1 %}
{% set single_dockerfile_in_root = is_single_dockerfile and (dockerfile_paths[0] == "Dockerfile" or "/" not in dockerfile_paths[0]) %}
{% if dockerfile_paths|length > 0 and not single_dockerfile_in_root %}
{# Несколько Dockerfile или один не в корне - создаем отдельную джобу для каждого #}
{% for dockerfile_path in dockerfile_paths %}
{% set dockerfile_dir = dockerfile_path.rsplit('/', 1)[0] if '/' in dockerfile_path else '.' %}
{% set service_name_raw = dockerfile_dir.split('/')[-1] if dockerfile_dir != '.' else 'main' %}
{% set service_name = service_name_raw | lower %}
{% set service_name_safe = service_name_raw | lower | replace('-', '_') | replace('/', '_') %}
{% set image_name = (ctx.project_name | default("myapp")) | lower %}
{% set image_tag = ctx.tag | default("$CI_COMMIT_SHORT_SHA") %}
{% set registry = ctx.registry | default("$CI_REGISTRY") %}
{% if registry == "$CI_REGISTRY" or registry == "$CI_REGISTRY_IMAGE" %}
{% set full_image_name = "$CI_REGISTRY_IMAGE-" + service_name %}
{% else %}
{% set full_image_name = registry + "/" + image_name + "-" + service_name %}
{% endif %}
docker_push_{{ service_name_safe }}:
  stage: docker_push
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  dependencies:
    - docker_build
  script:
    - docker load -i image-{{ service_name_safe }}.tar || true
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" $CI_REGISTRY --password-stdin
{% if registry == "$CI_REGISTRY" or registry == "$CI_REGISTRY_IMAGE" %}
    - docker push $CI_REGISTRY_IMAGE-{{ service_name }}:{{ image_tag }}
{% else %}
    - docker push {{ full_image_name }}:{{ image_tag }}
{% endif %}
{% endfor %}
{% else %}
{# Один Dockerfile в корне - используем стандартные переменные #}
docker_push:
  stage: docker_push
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
  dependencies:
    - docker_build
  script:
    - docker load -i image.tar || true
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" $CI_REGISTRY --password-stdin
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
{% endif %}
