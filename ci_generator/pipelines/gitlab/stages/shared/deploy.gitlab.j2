{% if ctx.use_docker_compose %}
deploy:
  stage: deploy
  image: docker/compose:2.24.0
  variables:
    DOCKER_HOST: tcp://docker:2375
  services:
    - docker:24-dind
  dependencies:
    - docker_push
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" $CI_REGISTRY --password-stdin
  script:
    - |
      # Экспортируем переменные для docker-compose
      export CI_REGISTRY_IMAGE=$CI_REGISTRY_IMAGE
      export IMAGE_TAG=${CI_COMMIT_SHORT_SHA:-latest}
      
      # Запускаем docker-compose
      docker-compose -f docker-compose.yml pull || true
      docker-compose -f docker-compose.yml up -d
      
      # Проверяем статус сервисов
      docker-compose -f docker-compose.yml ps
  environment:
    name: production
    url: http://$CI_PROJECT_NAME
  when: manual
  only:
    - main
    - master
{% endif %}

