# Generated GitLab CI (auto)
stages:
  - pre_checks
  - lint
  - type_check
  - security
  - test
  - docker_build
  - docker_push
  - migration
  - deploy
  - cleanup

# Triggers (from user_settings.triggers)
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_PIPELINE_SOURCE == "push"'
    - if: '$CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE == "push"'





# Common variables
variables:
  DOCKER_IMAGE: "$CI_REGISTRY_IMAGE"
  DOCKER_TAG: "$CI_COMMIT_SHORT_SHA"
  GO_VERSION: "1.21"

  # Required CI/CD variables for this pipeline (configure in GitLab settings)
  # CI_REGISTRY: GitLab container registry URL (usually predefined)
  # CI_REGISTRY_USER: registry username for docker login
  # CI_REGISTRY_PASSWORD: registry password/token for docker login
  # KUBECONFIG_CONTENT: base64-encoded kubeconfig for Kubernetes deploy

# User variables (inlined - prefer CI platform variables for secrets)

pre_checks:
  stage: pre_checks
  image: golang:1.21
  script:
    - go version
    - echo "Basic repo checks (lint config, presence of tests, dockerfile...)"

lint:
  stage: lint
  image: golangci/golangci-lint:v1.56.2
  script:
    - golangci-lint run --out-format code-climate:gl-code-quality-report.json,line-number || true
    - golangci-lint run || true
  artifacts:
    reports:
      codequality: gl-code-quality-report.json
    paths:
      - gl-code-quality-report.json
type_check:
  stage: type_check
  image: golang:1.21
  script:
    - go mod download || true
    - go vet ./... || true
    - go build -o /dev/null ./... || true
security:
  stage: security
  image: golang:1.21
  script:
    - go install github.com/securego/gosec/v2/cmd/gosec@latest || true
    - gosec -fmt json -out gosec-report.json ./... || true
  artifacts:
    paths:
      - gosec-report.json
    expire_in: 1 week

test:
  stage: test
  
  image: golang:1.21
  
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
  
  before_script:
    - mkdir -p .go
    - export GOPATH=${CI_PROJECT_DIR}/.go
  
  script:
    - go mod download || true
    - go test -v -race -coverprofile=coverage.out -covermode=atomic ./... || true
    - go tool cover -html=coverage.out -o coverage.html || true
    - go tool cover -func=coverage.out || true
  
  coverage: '/coverage: \d+.\d+% of statements/'
  
  artifacts:
    when: always
    paths:
      - coverage.out
      - coverage.html
    expire_in: 1 week
build_and_push:
  stage: docker_build
  image: docker:24
  services:
    - name: docker:24-dind
      command: ["--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
  before_script:
    - docker info
    - echo "Checking GitLab CI variables..."
    - echo "Logging to GitLab Container Registry with CI_JOB_TOKEN..."
    - echo "$CI_JOB_TOKEN" | docker login -u "gitlab-ci-token" "$CI_REGISTRY" --password-stdin
  script:
    - echo "Building and pushing Docker images..."
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile.strelaysrv -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile.stcrashreceiver -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile.ursrv -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile.stupgrades -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile.builder -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile.strelaypoolsrv -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    # Main
    - echo "Building Main..."
    - docker build -f Dockerfile.stdiscosrv -t $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA -t $CI_REGISTRY_IMAGE-main:latest .
    - echo "Pushing Main..."
    - docker push $CI_REGISTRY_IMAGE-main:$CI_COMMIT_SHORT_SHA || echo "Failed to push $CI_COMMIT_SHORT_SHA tag"
    - docker push $CI_REGISTRY_IMAGE-main:latest || echo "Failed to push latest tag"
    - echo "âœ… Main pushed successfully"
    
    - echo "ðŸŽ‰ All images built and pushed successfully!"
  after_script:
    - docker logout $CI_REGISTRY || true


migration:
  stage: migration
  image: golang:1.21
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .go/pkg/mod/
  before_script:
    - mkdir -p .go
    - export GOPATH=${CI_PROJECT_DIR}/.go
  script:
    - go mod download || true
    - echo "No migration tool detected" || true
  only:
    - main
    - develop

cleanup:
  stage: cleanup
  image: docker:24
  services:
    - docker:24-dind
  script:
    - docker system prune -f || true