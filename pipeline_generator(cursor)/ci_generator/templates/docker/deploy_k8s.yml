deploy_docker_k8s:
  stage: deploy
  image: bitnami/kubectl:latest
  dependencies:
    - build_and_push_docker
  variables:
    DOCKER_IMAGE: ${CI_REGISTRY_IMAGE:-${CI_PROJECT_PATH}}:${CI_COMMIT_REF_SLUG:-latest}
    KUBECTL_VERSION: "latest"
  before_script:
    - kubectl version --client
    - |
      if [ -n "$KUBECONFIG" ]; then
        echo "$KUBECONFIG" | base64 -d > kubeconfig
        export KUBECONFIG=./kubeconfig
      fi
  script:
    - |
      if [ -f k8s/deployment.yaml ]; then
        kubectl apply -f k8s/deployment.yaml
      elif [ -f k8s/manifests.yaml ]; then
        kubectl apply -f k8s/manifests.yaml
      elif [ -d k8s/ ]; then
        kubectl apply -f k8s/
      else
        echo "No Kubernetes manifests found in k8s/ directory"
        exit 1
      fi
    - kubectl set image deployment/${CI_PROJECT_NAME:-app} app=${DOCKER_IMAGE} || echo "Deployment update skipped"
    - kubectl rollout status deployment/${CI_PROJECT_NAME:-app} || echo "Rollout status check skipped"
    - echo "Deployed ${DOCKER_IMAGE} to Kubernetes"
  environment:
    name: ${CI_ENVIRONMENT_NAME:-production}
    url: ${CI_ENVIRONMENT_URL:-https://${CI_PROJECT_NAME}.example.com}
  only:
    - main
  when: manual



