deploy_docker_ssh:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build_and_push_docker
  variables:
    DOCKER_IMAGE: ${CI_REGISTRY_IMAGE:-${CI_PROJECT_PATH}}:${CI_COMMIT_REF_SLUG:-latest}
    SSH_PRIVATE_KEY: ""
    DEPLOY_HOST: ""
    DEPLOY_USER: "deploy"
  before_script:
    - apk add --no-cache openssh-client docker-cli
    - ssh-agent -s > /dev/null 2>&1 || export SSH_AUTH_SOCK=/tmp/ssh-agent.sock && ssh-agent -a $SSH_AUTH_SOCK > /dev/null 2>&1
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H ${DEPLOY_HOST} >> ~/.ssh/known_hosts || true
  script:
    - |
      ssh ${DEPLOY_USER}@${DEPLOY_HOST} << EOF
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        docker pull ${DOCKER_IMAGE}
        docker stop ${CI_PROJECT_NAME:-app} || true
        docker rm ${CI_PROJECT_NAME:-app} || true
        docker run -d --name ${CI_PROJECT_NAME:-app} --restart unless-stopped ${DOCKER_IMAGE}
        docker system prune -f
      EOF
    - echo "Deployed ${DOCKER_IMAGE} via SSH to ${DEPLOY_HOST}"
  environment:
    name: ${CI_ENVIRONMENT_NAME:-production}
    url: ${CI_ENVIRONMENT_URL:-http://${DEPLOY_HOST}}
  only:
    - main
  when: manual

