test:
  stage: test
  image: python:${PYTHON_VERSION:-3.11}
  cache:
    key: ${CI_COMMIT_REF_SLUG}-python
    paths:
      - .pip-cache
  dependencies: []
  before_script:
    - pip install --cache-dir .pip-cache -r requirements.txt
    - pip install pytest pytest-cov pytest-asyncio
  script:
    - pytest tests/ -v --cov=. --cov-report=xml --cov-report=html
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

