
pipeline = """stages:\n- lint\n- test\n- build\nworkflow:\n  rules:\n  - if: $CI_COMMIT_BRANCH == \"main\"\nlint:\n  stage: lint\n  script:\n  - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics\n  - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics\n  - pylint **/*.py || true\n  - black --check .\n  - isort --check-only .\n  - mypy . --ignore-missing-imports || true\n  image: python:3.11\n  cache:\n    key: ${CI_COMMIT_REF_SLUG}-python\n    paths:\n    - .pip-cache\n  before_script:\n  - pip install --cache-dir .pip-cache flake8 pylint black isort mypy\n  allow_failure: true\n  rules:\n  - if: $CI_COMMIT_BRANCH == \"main\"\ntest:\n  stage: test\n  script:\n  - pytest tests/ -v --cov=. --cov-report=xml --cov-report=html || pytest . -v --cov=.\n    --cov-report=xml --cov-report=html\n  image: python:3.11\n  cache:\n    key: ${CI_COMMIT_REF_SLUG}-python\n    paths:\n    - .pip-cache\n  artifacts:\n    reports:\n      coverage_report:\n        coverage_format: cobertura\n        path: coverage.xml\n    paths:\n    - htmlcov/\n    expire_in: 1 week\n  before_script:\n  - pip install --cache-dir .pip-cache -r requirements.txt\n  - pip install pytest pytest-cov pytest-asyncio pytest-django\n  rules:\n  - if: $CI_COMMIT_BRANCH == \"main\"\nbuild_and_push_docker:\n  stage: build\n  script:\n  - \"docker build \\\\\\n  --tag  \\\\\\n  --tag :${CI_COMMIT_SHORT_SHA} \\\\\\n  --file ${DOCKERFILE:-Dockerfile}\\\n    \\ \\\\\\n  ${BUILD_ARGS:+.}\\n\"\n  - 'docker push '\n  - docker push :${CI_COMMIT_SHORT_SHA}\n  - \"if [ \\\"$CI_COMMIT_TAG\\\" ]; then\\n  docker tag  ${CI_REGISTRY_IMAGE:-${CI_PROJECT_PATH}}:latest\\n\\\n    \\  docker push ${CI_REGISTRY_IMAGE:-${CI_PROJECT_PATH}}:latest\\nfi\\n\"\n  - echo \"Successfully built and pushed \"\n  image: docker:24\n  services:\n  - docker:24-dind\n  variables:\n    DOCKER_HOST: tcp://docker:2376\n    DOCKER_TLS_CERTDIR: /certs\n    DOCKER_IMAGE: ${CI_REGISTRY_IMAGE:-${CI_PROJECT_PATH}}:${CI_COMMIT_REF_SLUG:-latest}\n    DOCKER_TAG: ${CI_COMMIT_REF_SLUG:-latest}\n  before_script:\n  - docker info\n  - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY\n  - echo \"Building and pushing Docker image: ${DOCKER_IMAGE}\"\n  after_script:\n  - docker logout $CI_REGISTRY || true\n  - docker system prune -f || true\n  only:\n  - main\n  - develop\n  - tags\n  rules:\n  - if: $CI_COMMIT_BRANCH == \"main\"\n"""
print(pipeline)